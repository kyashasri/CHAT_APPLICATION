<!DOCTYPE html>
<html>
<head>
    <title>Private Chat</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="app-container">

    <div class="chat-area">

        <!-- Chat Header -->
        <div class="chat-header">
            <button onclick="goBack()" class="back-btn">‚Üê Back</button>
            <span class="chat-title">{{ name }}</span>
        </div>

        <!-- Chat Messages -->
        <div class="chat-box" id="chat-box">
            {% for msg in messages %}
                <div class="message {% if msg.sender == session['email'] %}sender{% else %}receiver{% endif %}">
                    <div class="bubble">
                        {{ msg.text }}
                        <div class="time">{{ msg.timestamp }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Input Bar -->
        <div class="input-bar">
            <input type="hidden" id="chat_id" value="{{ chat_id }}">
            <input type="text" id="message" placeholder="Type a message..." autocomplete="off">
            <button onclick="sendMessage()">Send</button>
        </div>

    </div>
</div>

<script>
function goBack() {
    window.history.back();
}

var socket = io();
var username = "{{ session['email'] }}";
var chat_id = document.getElementById("chat_id").value;
var chatBox = document.getElementById("chat-box");

// Join room
socket.emit("join_room", { chat_id: chat_id });

// Send message function
function sendMessage() {
    var messageInput = document.getElementById("message");
    var message = messageInput.value.trim();
    if (!message) return;

    socket.emit("send_message", {
        message: message,
        sender: username,
        chat_id: chat_id
    });

    messageInput.value = "";
}

// Send message on Enter key
document.getElementById("message").addEventListener("keydown", function(e) {
    if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
    }
});

// Receive messages
socket.on("receive_message", function(data) {
    var messageDiv = document.createElement("div");
    messageDiv.classList.add("message", data.sender === username ? "sender" : "receiver");

    messageDiv.innerHTML = `
        <div class="bubble">
            ${data.message}
            <div class="time">${data.timestamp}</div>
        </div>
    `;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
});

// Auto scroll on load
window.onload = function() {
    chatBox.scrollTop = chatBox.scrollHeight;
};
</script>

</body>
</html>
